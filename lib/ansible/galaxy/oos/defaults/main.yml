---
# defaults file for oos
alicloud_region: cn-beijing

state: present
# oos template parameters
template_name: clone_instances_across_region-test
content: '{"FormatVersion": "OOS-2019-06-01", "Description": "Cross Region copy and run ECS instance by InstanceIds.", "Parameters": {"instanceIds": {"Description": "The ID list of the ECS instance.", "Type": "List"}, "regionId": {"Description": "The Source Region Id.", "Type": "String", "MinLength": 1, "MaxLength": 30}, "targetRegionId": {"Description": "The Target Region Id.", "Type": "String", "MinLength": 1, "MaxLength": 30}, "targetZoneId": {"Description": "The Target Zone Id.", "Type": "String", "MinLength": 1, "MaxLength": 30}, "targetInstanceType": {"Description": "The instance type for the ECS instances, ecs.g5.large, for example.", "Type": "String", "AllowedPattern": "ecs\\\\.[A-Za-z0-9\\\\.\\\\-]*", "MinLength": 1, "MaxLength": 30}, "targetSecurityGroupId": {"Description": "The security group ID for the ECS instances, sg-xxxxxxxxxxxxxxxxxxxx, for example.", "Type": "String", "AllowedPattern": "sg-[A-Za-z0-9]*", "MinLength": 1, "MaxLength": 30}, "targetVSwitchId": {"Description": "The virtual switch ID for the ECS instances, vsw-xxxxxxxxxxxxxxxxxxxx, for example.", "Type": "String", "AllowedPattern": "vsw-[A-Za-z0-9]*", "MinLength": 1, "MaxLength": 30}, "OOSAssumeRole": {"Description": "The RAM role to be assumed by OOS.", "Type": "String", "Default": "OOSServiceRole"}}, "RamRole": "\{\{ OOSAssumeRole \}\}", "Tasks": [{"Name": "createImage", "Action": "ACS::ExecuteAPI", "Description": "Create Image.", "Properties": {"Service": "ECS", "API": "CreateImage", "Parameters": {"RegionId": "\{\{ regionId \}\}", "ImageName": "img-\{\{ ACS::TaskLoopItem \}\}-\{\{ACS::ExecutionId\}\}", "InstanceId": "\{\{ ACS::TaskLoopItem \}\}"}}, "Loop": {"Items": "\{\{ instanceIds \}\}", "Outputs": {"ImageIds": {"AggregateType": "Fn::ListJoin", "AggregateField": "ImageId"}}}, "Outputs": {"ImageId": {"ValueSelector": "ImageId", "Type": "String"}}}, {"Name": "untilCreateImageReady", "Action": "ACS::WaitFor", "Description": "Wait For created images available.", "Properties": {"Service": "ECS", "API": "DescribeImages", "Parameters": {"RegionId": "\{\{ regionId \}\}", "ImageId": "\{\{ ACS::TaskLoopItem \}\}"}, "DesiredValues": ["Available"], "PropertySelector": "Images.Image[].Status"}, "Loop": {"Items": "\{\{ createImage.ImageIds \}\}"}, "Retries": 17}, {"Name": "copyImage", "Action": "ACS::ExecuteAPI", "Description": "Copy image.", "Properties": {"Service": "ECS", "API": "CopyImage", "Parameters": {"RegionId": "\{\{ regionId \}\}", "ImageId": "\{\{ ACS::TaskLoopItem \}\}", "DestinationRegionId": "\{\{ targetRegionId \}\}"}}, "Loop": {"Items": "\{\{ createImage.ImageIds \}\}", "Outputs": {"ImageIds": {"AggregateType": "Fn::ListJoin", "AggregateField": "ImageId"}}}, "Outputs": {"ImageId": {"ValueSelector": "ImageId", "Type": "String"}}}, {"Name": "untilCopyImageReady", "Action": "ACS::WaitFor", "Description": "Wait for copied images available.", "Properties": {"Service": "ECS", "API": "DescribeImages", "Parameters": {"RegionId": "\{\{ targetRegionId \}\}", "ImageId": "\{\{ ACS::TaskLoopItem \}\}"}, "DesiredValues": ["Available"], "PropertySelector": "Images.Image[].Status"}, "Loop": {"Items": "\{\{ copyImage.ImageIds \}\}"}}, {"Name": "runInstances", "Action": "ACS::ExecuteAPI", "Description": "run instances.", "Properties": {"Service": "ECS", "API": "RunInstances", "Parameters": {"RegionId": "\{\{ targetRegionId \}\}", "ZoneId": "\{\{ targetZoneId \}\}", "ImageId": "\{\{ ACS::TaskLoopItem \}\}", "InstanceType": "\{\{ targetInstanceType \}\}", "SecurityGroupId": "\{\{ targetSecurityGroupId \}\}", "VSwitchId": "\{\{ targetVSwitchId \}\}"}}, "Loop": {"Items": "\{\{ copyImage.ImageIds \}\}", "Outputs": {"instanceIds": {"AggregateType": "Fn::ListJoin", "AggregateField": "instanceId"}}}, "Outputs": {"instanceId": {"Type": "String", "ValueSelector": "InstanceIdSets.InstanceIdSet[]"}}}, {"Name": "untilInstanceReady", "Action": "ACS::WaitFor", "Description": "Wait for instances running", "Properties": {"Service": "ECS", "API": "DescribeInstances", "Parameters": {"RegionId": "\{\{ targetRegionId \}\}", "InstanceIds": "\{\{ runInstances.instanceIds \}\}"}, "DesiredValues": ["Running"], "PropertySelector": ".Instances.Instance[].Status"}}], "Outputs": {"instanceIds": {"Value": "\{\{ runInstances.instanceIds \}\}", "Type": "List"}}}'

# oos execution parameters
instance_ids: [i-bp1d3zexxxxxxxxx]
region_id: cn-hangzhou
target_region_id: cn-beijing
target_zone_id: cn-beijing-h
target_instance_type: ecs.g6.large
target_security_group_id: sg-test
target_vSwitch_id: vsw-test